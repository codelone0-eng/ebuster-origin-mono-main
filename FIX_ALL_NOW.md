# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –í–°–ï–• –ü–†–û–ë–õ–ï–ú –ë–î

## üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

### 1. ‚ùå Subscriptions - –Ω–µ—Ç –ø–æ–ª–µ–π amount, plan, features
**–û—à–∏–±–∫–∞:** `Could not find the 'amount' column`

### 2. ‚ùå Scripts - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ category
**–û—à–∏–±–∫–∞:** `column "category_id" does not exist`  
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –ë–î `category` (VARCHAR), –≤ –∫–æ–¥–µ `category_id` (UUID)

### 3. ‚ùå User_scripts - –Ω–µ—Ç FK –Ω–∞ user_id
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–≤—è–∑—å —Å auth_users –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞

### 4. ‚ö†Ô∏è RLS –æ—Ç–∫–ª—é—á–µ–Ω
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ roles –∏ subscriptions

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï - –û–¥–∏–Ω —Ñ–∞–π–ª –∏—Å–ø—Ä–∞–≤–∏—Ç –≤—Å—ë!

### –í—ã–ø–æ–ª–Ω–∏—Ç–µ: `migrations/COMPLETE_FIX_ALL.sql`

–≠—Ç–æ—Ç —Ñ–∞–π–ª:
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç `amount`, `plan`, `features` –≤ subscriptions
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç `category_id` –≤ scripts
3. ‚úÖ –ú–∏–≥—Ä–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `category` –≤ `category_id`
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç FK –Ω–∞ user_scripts.user_id
5. ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç auth_users.role —Å role_id
6. ‚úÖ –í–∫–ª—é—á–∏—Ç RLS –Ω–∞ roles –∏ subscriptions
7. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

## üöÄ –ö–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –í—Å—ë —Å—Ä–∞–∑—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
1. –û—Ç–∫—Ä—ã—Ç—å Supabase SQL Editor
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Ñ–∞–π–ª `COMPLETE_FIX_ALL.sql`
3. –í—Å—Ç–∞–≤–∏—Ç—å –∏ –Ω–∞–∂–∞—Ç—å **Run**
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ —á–∞—Å—Ç—è–º (–µ—Å–ª–∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω–∏—á–∞–µ—Ç–µ)
–í—ã–ø–æ–ª–Ω—è—Ç—å –±–ª–æ–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É:
1. –ß–ê–°–¢–¨ 1: Subscriptions
2. –ß–ê–°–¢–¨ 2: Scripts category
3. –ß–ê–°–¢–¨ 3: User_scripts FK
4. –ß–ê–°–¢–¨ 4: Auth_users sync
5. –ß–ê–°–¢–¨ 5: RLS
6. –ß–ê–°–¢–¨ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞

---

## üìã –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

### 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å API
```bash
docker compose restart api
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥–º–∏–Ω–∫—É
- –û—Ç–∫—Ä—ã—Ç—å https://ebuster.ru/admin
- –í–∫–ª–∞–¥–∫–∞ "–†–æ–ª–∏" - –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è
- –í–∫–ª–∞–¥–∫–∞ "–ü–æ–¥–ø–∏—Å–∫–∏" - –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã
- –°–∫—Ä–∏–ø—Ç—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è

---

## üéØ –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è:

### Subscriptions (–±—ã–ª–æ ‚Üí —Å—Ç–∞–ª–æ):
```sql
-- –ë–´–õ–û (14 –∫–æ–ª–æ–Ω–æ–∫):
id, user_id, role_id, status, start_date, end_date, 
payment_method, transaction_id, auto_renew, 
created_at, updated_at

-- –°–¢–ê–õ–û (17 –∫–æ–ª–æ–Ω–æ–∫):
id, user_id, role_id, status, start_date, end_date, 
payment_method, transaction_id, auto_renew,
amount, plan, features,  ‚Üê –ù–û–í–´–ï!
created_at, updated_at
```

### Scripts (–±—ã–ª–æ ‚Üí —Å—Ç–∞–ª–æ):
```sql
-- –ë–´–õ–û:
category VARCHAR  ‚Üê —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ

-- –°–¢–ê–õ–û:
category VARCHAR  ‚Üê –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
category_id UUID ‚Üí script_categories.id  ‚Üê –Ω–æ–≤–æ–µ –ø–æ–ª–µ —Å FK
```

### User_scripts (–±—ã–ª–æ ‚Üí —Å—Ç–∞–ª–æ):
```sql
-- –ë–´–õ–û:
user_id UUID (–±–µ–∑ FK)  ‚Üê –æ–ø–∞—Å–Ω–æ!

-- –°–¢–ê–õ–û:
user_id UUID ‚Üí auth_users.id  ‚Üê —Å FK –∏ CASCADE
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ:

- –ú–∏–≥—Ä–∞—Ü–∏—è **–±–µ–∑–æ–ø–∞—Å–Ω–∞** - –Ω–µ —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `IF NOT EXISTS` - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
- –°—Ç–∞—Ä—ã–µ –ø–æ–ª—è **—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è **–æ–±—Ä–∞—Ç–∏–º—ã**

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ subscriptions
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'subscriptions' 
AND column_name IN ('amount', 'plan', 'features');
-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 3 —Å—Ç—Ä–æ–∫–∏

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ scripts
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'scripts' 
AND column_name IN ('category', 'category_id');
-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 2 —Å—Ç—Ä–æ–∫–∏

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ FK
SELECT constraint_name FROM information_schema.table_constraints
WHERE table_name = 'user_scripts' 
AND constraint_name = 'fk_user_scripts_user_id';
-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 1 —Å—Ç—Ä–æ–∫—É

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS
SELECT tablename, rowsecurity FROM pg_tables
WHERE tablename IN ('roles', 'subscriptions');
-- –û–±–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å true
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:
- ‚úÖ API `/api/admin/subscriptions` –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–∫—Ä–∏–ø—Ç—ã –±—É–¥—É—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
- ‚úÖ –í—Å–µ FK –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ RLS –∑–∞—â–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ `COMPLETE_FIX_ALL.sql` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ API!** üöÄ
