name: üöÄ –£–º–Ω—ã–π –î–µ–ø–ª–æ–π –≤ Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI

env:
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  # ============================================
  # JOB 1: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ù–´–• –ö–û–ú–ü–û–ù–ï–ù–¢–û–í
  # ============================================
  detect-changes:
    name: üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.changes.outputs.api }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      docker-changed: ${{ steps.changes.outputs.docker }}
      all-changed: ${{ steps.changes.outputs.all }}
    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # –ù—É–∂–Ω–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–æ–º–º–∏—Ç–æ–º
      
      - name: üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        id: changes
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
          API_CHANGED=false
          FRONTEND_CHANGED=false
          DOCKER_CHANGED=false
          ALL_CHANGED=false
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # –ü—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –¥–µ–ø–ª–æ–∏–º –≤—Å–µ
            API_CHANGED=true
            FRONTEND_CHANGED=true
            DOCKER_CHANGED=true
            ALL_CHANGED=true
            echo "api=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "docker=true" >> $GITHUB_OUTPUT
            echo "all=true" >> $GITHUB_OUTPUT
            echo "‚úÖ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ - –¥–µ–ø–ª–æ–∏–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã"
          else
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            echo "üìã –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
            echo "$CHANGED_FILES"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ API (–∏—Å–∫–ª—é—á–∞–µ–º .github/workflows/deploy.yml)
            if echo "$CHANGED_FILES" | grep -qE "(^src/api/|^server\.ts|^Dockerfile\.api)"; then
              API_CHANGED=true
              echo "api=true" >> $GITHUB_OUTPUT
              echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ API"
            else
              echo "api=false" >> $GITHUB_OUTPUT
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (–∏—Å–∫–ª—é—á–∞–µ–º src/api/)
            if echo "$CHANGED_FILES" | grep -qE "(^src/(components|pages|landing|lk|admin|DashboardApp|LandingApp|AdminApp|main\.tsx|App\.tsx)/|^Dockerfile\.frontend|^nginx\.conf|^vite\.config|^tailwind\.config|^index\.html)"; then
              FRONTEND_CHANGED=true
              echo "frontend=true" >> $GITHUB_OUTPUT
              echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ"
            else
              echo "frontend=false" >> $GITHUB_OUTPUT
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (nginx.conf –∏—Å–∫–ª—é—á–µ–Ω, —Ç.–∫. –æ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è frontend)
            if echo "$CHANGED_FILES" | grep -qE "(^docker-compose\.yml|^Dockerfile\.api)"; then
              DOCKER_CHANGED=true
              echo "docker=true" >> $GITHUB_OUTPUT
              echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
            else
              echo "docker=false" >> $GITHUB_OUTPUT
            fi
            
            # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –æ–±—â–∏–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –æ–±–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ - –¥–µ–ø–ª–æ–∏–º –≤—Å–µ
            if echo "$CHANGED_FILES" | grep -qE "(^package\.json|^package-lock\.json|^tsconfig|^\.env)"; then
              ALL_CHANGED=true
              echo "all=true" >> $GITHUB_OUTPUT
              echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±—â–∏—Ö —Ñ–∞–π–ª–∞—Ö - –¥–µ–ø–ª–æ–∏–º –≤—Å–µ"
            elif [ "$API_CHANGED" = "true" ] && [ "$FRONTEND_CHANGED" = "true" ]; then
              ALL_CHANGED=true
              echo "all=true" >> $GITHUB_OUTPUT
              echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–æ–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö - –¥–µ–ø–ª–æ–∏–º –≤—Å–µ"
            else
              echo "all=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo ""
          echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:"
          echo "   API: ${API_CHANGED:-false}"
          echo "   Frontend: ${FRONTEND_CHANGED:-false}"
          echo "   Docker: ${DOCKER_CHANGED:-false}"
          echo "   All: ${ALL_CHANGED:-false}"

  # ============================================
  # JOB 2: –î–ï–ü–õ–û–ô
  # ============================================
  deploy:
    name: üì¶ –î–µ–ø–ª–æ–π EBUSTER –Ω–∞ Production —Å–µ—Ä–≤–µ—Ä
    runs-on: ubuntu-latest
    needs: detect-changes
    timeout-minutes: 30
    env:
      DEPLOY_API: ${{ needs.detect-changes.outputs.api-changed == 'true' || needs.detect-changes.outputs.all-changed == 'true' || needs.detect-changes.outputs.docker-changed == 'true' }}
      DEPLOY_FRONTEND: ${{ needs.detect-changes.outputs.frontend-changed == 'true' || needs.detect-changes.outputs.all-changed == 'true' || needs.detect-changes.outputs.docker-changed == 'true' }}
    
    steps:
      # ============================================
      # –≠–¢–ê–ü 0: –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ù–ê–ß–ê–õ–ï –î–ï–ü–õ–û–Ø
      # ============================================
      
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –¥–µ–ø–ª–æ—è
        if: env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          DEPLOY_INFO=""
          if [ "${{ env.DEPLOY_API }}" = "true" ]; then
            DEPLOY_INFO="${DEPLOY_INFO}‚Ä¢ API Backend\n"
          fi
          if [ "${{ env.DEPLOY_FRONTEND }}" = "true" ]; then
            DEPLOY_INFO="${DEPLOY_INFO}‚Ä¢ Frontend (–õ–µ–Ω–¥–∏–Ω–≥, –õ–ö, –ê–¥–º–∏–Ω–∫–∞)\n"
          fi
          if [ "${{ env.DEPLOY_AUTOTEST }}" = "true" ]; then
            DEPLOY_INFO="${DEPLOY_INFO}‚Ä¢ Autotest\n"
          fi
          if [ -z "$DEPLOY_INFO" ]; then
            DEPLOY_INFO="‚Ä¢ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –¥–µ–ø–ª–æ—è"
          fi
          
          MESSAGE="üöÄ <b>–ù–∞—á–∞–ª–æ —É–º–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è EBUSTER</b>
          
          üìå <b>–ö–æ–º–º–∏—Ç:</b> <code>$COMMIT_HASH</code>
          üìù <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b> $COMMIT_MSG
          üë§ <b>–ê–≤—Ç–æ—Ä:</b> $COMMIT_AUTHOR
          üåø <b>–í–µ—Ç–∫–∞:</b> $BRANCH
          üïê <b>–í—Ä–µ–º—è:</b> $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          üì¶ <b>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –¥–µ–ø–ª–æ—è:</b>
          $DEPLOY_INFO
          
          ‚è≥ –î–µ–ø–ª–æ–π –Ω–∞—á–∞—Ç..."
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true)
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: $RESPONSE"
          fi
      
      # ============================================
      # –≠–¢–ê–ü 1: –ü–û–î–ì–û–¢–û–í–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø
      # ============================================
      
      - name: üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
      
      # ============================================
      # –≠–¢–ê–ü 2: –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£ –ò –ü–û–î–ì–û–¢–û–í–ö–ê
      # ============================================
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "echo '‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω' && df -h | head -2"
      
      - name: üìÇ –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
            echo "üìå –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $(git rev-parse HEAD 2>/dev/null || echo '–Ω–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π')"
          ENDSSH
      
      - name: üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "")
            echo "üíæ –°–æ—Ö—Ä–∞–Ω—ë–Ω –∫–æ–º–º–∏—Ç –¥–ª—è –æ—Ç–∫–∞—Ç–∞: $CURRENT_COMMIT"
            echo "$CURRENT_COMMIT" > /tmp/ebuster_rollback_commit.txt || true
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 3: –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê –ù–ê –°–ï–†–í–ï–†–ï
      # ============================================
      
      - name: üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ GitHub
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üîÑ –ü–æ–ª—É—á–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ main –≤–µ—Ç–∫–∏..."
            git fetch origin main
            git reset --hard origin/main
            echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω –¥–æ –∫–æ–º–º–∏—Ç–∞: $(git rev-parse HEAD)"
            echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: $(git log -1 --pretty=format:'%h - %s')"
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 4: –û–°–¢–ê–ù–û–í–ö–ê –°–¢–ê–†–´–• –ö–û–ù–¢–ï–ô–ù–ï–†–û–í (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö)
      # ============================================
      
      - name: ‚è∏Ô∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
            if [ "${{ env.DEPLOY_API }}" = "true" ]; then
              echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
              docker compose stop api || echo "‚ö†Ô∏è  API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
            
            if [ "${{ env.DEPLOY_FRONTEND }}" = "true" ]; then
              echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Frontend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
              docker compose stop frontend || echo "‚ö†Ô∏è  Frontend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
            
            if [ "${{ env.DEPLOY_AUTOTEST }}" = "true" ]; then
              echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Autotest –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
              docker compose stop autotest-server || echo "‚ö†Ô∏è  Autotest –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            fi
            
            # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∞ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ
            if [ "${{ needs.detect-changes.outputs.docker-changed }}" = "true" ]; then
              echo "üõë –ò–∑–º–µ–Ω–µ–Ω–∞ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
              docker compose down || echo "‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            fi
          ENDSSH
      
      - name: üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
        if: env.DEPLOY_API == 'true' || env.DEPLOY_FRONTEND == 'true' || env.DEPLOY_AUTOTEST == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üßπ –û—á–∏—â–∞—é –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã Docker –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π..."
            echo "üìä –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –¥–æ –æ—á–∏—Å—Ç–∫–∏:"
            df -h / | head -2
            echo ""
            echo "üóëÔ∏è  –£–¥–∞–ª—è—é –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –æ–±—Ä–∞–∑—ã –∏ build cache..."
            docker system prune -f || true
            docker builder prune -f || true
            echo ""
            echo "üìä –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:"
            df -h / | head -2
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 5: –°–ë–û–†–ö–ê –ö–û–ú–ü–û–ù–ï–ù–¢–û–í (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö)
      # ============================================
      
      - name: üî® –°–±–æ—Ä–∫–∞ API Backend —Å–µ—Ä–≤–µ—Ä–∞
        if: env.DEPLOY_API == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üî® –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É API Backend..."
            echo "üì¶ Dockerfile: Dockerfile.api"
            echo "üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: Express —Å–µ—Ä–≤–µ—Ä, API —Ä–æ—É—Ç—ã, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞"
            docker compose build --no-cache api
            echo "‚úÖ API Backend —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
          ENDSSH
      
      - name: üé® –°–±–æ—Ä–∫–∞ UI (Frontend - –õ–µ–Ω–¥–∏–Ω–≥, –õ–ö, –ê–¥–º–∏–Ω–∫–∞)
        if: env.DEPLOY_FRONTEND == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üé® –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É UI..."
            echo "üì¶ Dockerfile: Dockerfile.frontend"
            echo "üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, Tailwind CSS, Vite —Å–±–æ—Ä–∫–∞"
            echo "üåê –î–æ–º–µ–Ω—ã: ebuster.ru, lk.ebuster.ru, admin.ebuster.ru"
            docker compose build --no-cache frontend
            echo "‚úÖ UI —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
          ENDSSH
      
      - name: üì° –°–±–æ—Ä–∫–∞ Autotest Server
        if: env.DEPLOY_AUTOTEST == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üì° –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É Autotest Server..."
            echo "üì¶ Dockerfile: Dockerfile.autotest-server"
            echo "üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: Express —Å–µ—Ä–≤–µ—Ä, WebSocket, –¥–∞—à–±–æ—Ä–¥, recorder"
            echo "üåê –ü–æ—Ä—Ç: 3002"
            docker compose build --no-cache autotest-server
            echo "‚úÖ Autotest Server —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 6: –ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í
      # ============================================
      
      - name: ‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            
            # –°–æ–∑–¥–∞—Ç—å —Å–µ—Ç—å –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            echo "üåê –ü—Ä–æ–≤–µ—Ä—è—é —Å–µ—Ç—å ebuster-network..."
            if ! docker network ls | grep -q ebuster-network; then
              echo "üì° –°–æ–∑–¥–∞—é —Å–µ—Ç—å ebuster-network..."
              docker network create ebuster-network || true
            fi
            
            echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∏–ª–∏ –≤—Å–µ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∞ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
            if [ "${{ needs.detect-changes.outputs.docker-changed }}" = "true" ]; then
              echo "üìã –ó–∞–ø—É—Å–∫–∞—é –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã (–∏–∑–º–µ–Ω–µ–Ω–∞ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)..."
              docker compose up -d
            else
              # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
              if [ "${{ env.DEPLOY_API }}" = "true" ]; then
                echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞—é API..."
                docker compose up -d api
              fi
              
              if [ "${{ env.DEPLOY_FRONTEND }}" = "true" ]; then
                echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞—é Frontend..."
                docker compose up -d frontend
              fi
              
              if [ "${{ env.DEPLOY_AUTOTEST }}" = "true" ]; then
                echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞—é Autotest..."
                docker compose up -d autotest-server
              fi
            fi
            
            echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã"
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 7: –û–ñ–ò–î–ê–ù–ò–ï –ó–ê–ü–£–°–ö–ê –°–ï–†–í–ò–°–û–í
      # ============================================
      
      - name: ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "‚è≥ –û–∂–∏–¥–∞—é –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (15 —Å–µ–∫—É–Ω–¥)..."
            sleep 15
            echo "‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 8: –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í
      # ============================================
      
      - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üìä –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose ps
            echo ""
            echo "üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" || true
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 9: –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–û–°–¢–ò
      # ============================================
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API Backend (api.ebuster.ru)
        if: env.DEPLOY_API == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é API Backend..."
            for i in {1..5}; do
              if curl -f -s https://api.ebuster.ru/api/health > /dev/null; then
                echo "‚úÖ API Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
                curl -s https://api.ebuster.ru/api/health | head -5
                exit 0
              fi
              echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/5... –û–∂–∏–¥–∞—é 3 —Å–µ–∫—É–Ω–¥—ã"
              sleep 3
            done
            echo "‚ùå API Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫"
            exit 1
          ENDSSH
      
      - name: üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –õ–µ–Ω–¥–∏–Ω–≥–∞ (ebuster.ru)
        if: env.DEPLOY_FRONTEND == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üåê –ü—Ä–æ–≤–µ—Ä—è—é –õ–µ–Ω–¥–∏–Ω–≥..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://ebuster.ru/ || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ –õ–µ–Ω–¥–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $STATUS)"
            else
              echo "‚ö†Ô∏è  –õ–µ–Ω–¥–∏–Ω–≥ –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å: $STATUS"
            fi
          ENDSSH
      
      - name: üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ (lk.ebuster.ru)
        if: env.DEPLOY_FRONTEND == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üë§ –ü—Ä–æ–≤–µ—Ä—è—é –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://lk.ebuster.ru/ || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $STATUS)"
            else
              echo "‚ö†Ô∏è  –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å: $STATUS"
            fi
          ENDSSH
      
      - name: üõ°Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª–∏ (admin.ebuster.ru)
        if: env.DEPLOY_FRONTEND == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üõ°Ô∏è  –ü—Ä–æ–≤–µ—Ä—è—é –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://admin.ebuster.ru/ || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ (HTTP $STATUS)"
            else
              echo "‚ö†Ô∏è  –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ —Å—Ç–∞—Ç—É—Å: $STATUS"
            fi
          ENDSSH
      
      - name: üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ Autotest Server
        if: env.DEPLOY_AUTOTEST == 'true'
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üì° –ü—Ä–æ–≤–µ—Ä—è—é Autotest Server..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3002/api/status || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Autotest Server —Ä–∞–±–æ—Ç–∞–µ—Ç (HTTP $STATUS)"
            else
              echo "‚ö†Ô∏è  Autotest Server –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å: $STATUS"
            fi
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 10: –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò –û–¢–ß–Å–¢
      # ============================================
      
      - name: üìã –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ –¥–µ–ø–ª–æ–µ
        if: success()
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "üéâ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–Å–ù!"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üìå –†–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –∫–æ–º–º–∏—Ç: $(git rev-parse HEAD)"
            echo "üìù –°–æ–æ–±—â–µ–Ω–∏–µ: $(git log -1 --pretty=format:'%s')"
            echo "üë§ –ê–≤—Ç–æ—Ä: $(git log -1 --pretty=format:'%an')"
            echo "üïê –í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "‚úÖ –†–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:"
            if [ "${{ env.DEPLOY_API }}" = "true" ]; then
              echo "   ‚Ä¢ API Backend: https://api.ebuster.ru"
            fi
            if [ "${{ env.DEPLOY_FRONTEND }}" = "true" ]; then
              echo "   ‚Ä¢ –õ–µ–Ω–¥–∏–Ω–≥: https://ebuster.ru"
              echo "   ‚Ä¢ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç: https://lk.ebuster.ru"
              echo "   ‚Ä¢ –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å: https://admin.ebuster.ru"
            fi
            if [ "${{ env.DEPLOY_AUTOTEST }}" = "true" ]; then
              echo "   ‚Ä¢ Autotest Dashboard: https://autotest.ebuster.ru"
            fi
            echo ""
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
            echo ""
          ENDSSH
      
      - name: ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ
        if: success() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_HASH=$(git rev-parse --short HEAD)
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          DEPLOYED_SERVICES=""
          if [ "${{ env.DEPLOY_API }}" = "true" ]; then
            DEPLOYED_SERVICES="${DEPLOYED_SERVICES}‚Ä¢ API: <a href='https://api.ebuster.ru'>api.ebuster.ru</a>\n"
          fi
          if [ "${{ env.DEPLOY_FRONTEND }}" = "true" ]; then
            DEPLOYED_SERVICES="${DEPLOYED_SERVICES}‚Ä¢ –õ–µ–Ω–¥–∏–Ω–≥: <a href='https://ebuster.ru'>ebuster.ru</a>\n‚Ä¢ –õ–ö: <a href='https://lk.ebuster.ru'>lk.ebuster.ru</a>\n‚Ä¢ –ê–¥–º–∏–Ω–∫–∞: <a href='https://admin.ebuster.ru'>admin.ebuster.ru</a>\n"
          fi
          if [ "${{ env.DEPLOY_AUTOTEST }}" = "true" ]; then
            DEPLOYED_SERVICES="${DEPLOYED_SERVICES}‚Ä¢ Autotest: <a href='https://autotest.ebuster.ru'>autotest.ebuster.ru</a>\n"
          fi
          
          MESSAGE="‚úÖ <b>–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!</b>
          
          üìå <b>–ö–æ–º–º–∏—Ç:</b> <code>$COMMIT_HASH</code>
          üìù <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b> $COMMIT_MSG
          üë§ <b>–ê–≤—Ç–æ—Ä:</b> $COMMIT_AUTHOR
          üïê <b>–í—Ä–µ–º—è:</b> $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          üåê <b>–†–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–µ —Å–µ—Ä–≤–∏—Å—ã:</b>
          $DEPLOYED_SERVICES
          
          üìä <a href='$WORKFLOW_RUN_URL'>–î–µ—Ç–∞–ª–∏ –¥–µ–ø–ª–æ—è</a>"
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=false)
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: $RESPONSE"
          fi
      
      - name: ‚ùå –û—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–µ –¥–µ–ø–ª–æ—è
        if: failure()
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH' || true
            set +e
            cd /srv/ebuster
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "‚ùå –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ò–õ–°–Ø –° –û–®–ò–ë–ö–û–ô!"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üìã –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose logs --tail=50 || true
            echo ""
            echo "üíæ –î–ª—è –æ—Ç–∫–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
            ROLLBACK=$(cat /tmp/ebuster_rollback_commit.txt 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω")
            echo "   git reset --hard $ROLLBACK"
            echo "   docker compose up -d"
            echo ""
          ENDSSH
      
      - name: ‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–µ–ø–ª–æ—è
        if: failure() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an' || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
          COMMIT_HASH=$(git rev-parse --short HEAD || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          FAILED_STEP="${{ job.status }}"
          
          MESSAGE="‚ùå <b>–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!</b>
          
          üìå <b>–ö–æ–º–º–∏—Ç:</b> <code>$COMMIT_HASH</code>
          üìù <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b> $COMMIT_MSG
          üë§ <b>–ê–≤—Ç–æ—Ä:</b> $COMMIT_AUTHOR
          üïê <b>–í—Ä–µ–º—è:</b> $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ‚ö†Ô∏è <b>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞!</b>
          
          üìä <a href='$WORKFLOW_RUN_URL'>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>"
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=false)
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: $RESPONSE"
          fi
