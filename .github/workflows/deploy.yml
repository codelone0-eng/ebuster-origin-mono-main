name: üöÄ –î–µ–ø–ª–æ–π –≤ Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI

env:
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_USER: ${{ secrets.SERVER_USER }}

jobs:
  deploy:
    name: üì¶ –î–µ–ø–ª–æ–π EBUSTER –Ω–∞ Production —Å–µ—Ä–≤–µ—Ä
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # ============================================
      # –≠–¢–ê–ü 1: –ü–û–î–ì–û–¢–û–í–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø
      # ============================================
      
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
      
      # ============================================
      # –≠–¢–ê–ü 2: –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£ –ò –ü–û–î–ì–û–¢–û–í–ö–ê
      # ============================================
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "echo '‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω' && df -h | head -2"
      
      - name: üìÇ –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
            echo "üìå –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $(git rev-parse HEAD 2>/dev/null || echo '–Ω–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π')"
          ENDSSH
      
      - name: üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "")
            echo "üíæ –°–æ—Ö—Ä–∞–Ω—ë–Ω –∫–æ–º–º–∏—Ç –¥–ª—è –æ—Ç–∫–∞—Ç–∞: $CURRENT_COMMIT"
            echo "$CURRENT_COMMIT" > /tmp/ebuster_rollback_commit.txt || true
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 3: –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê –ù–ê –°–ï–†–í–ï–†–ï
      # ============================================
      
      - name: üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ GitHub
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üîÑ –ü–æ–ª—É—á–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ main –≤–µ—Ç–∫–∏..."
            git fetch origin main
            git reset --hard origin/main
            echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω –¥–æ –∫–æ–º–º–∏—Ç–∞: $(git rev-parse HEAD)"
            echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: $(git log -1 --pretty=format:'%h - %s')"
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 4: –û–°–¢–ê–ù–û–í–ö–ê –°–¢–ê–†–´–• –ö–û–ù–¢–ï–ô–ù–ï–†–û–í
      # ============================================
      
      - name: ‚è∏Ô∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker compose down || echo "‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            echo "üßπ –û—á–∏—â–∞—é –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã Docker..."
            docker system prune -f || true
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 5: –°–ë–û–†–ö–ê –ö–û–ú–ü–û–ù–ï–ù–¢–û–í
      # ============================================
      
      - name: üî® –°–±–æ—Ä–∫–∞ API Backend —Å–µ—Ä–≤–µ—Ä–∞
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üî® –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É API Backend..."
            echo "üì¶ Dockerfile: Dockerfile.api"
            echo "üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: Express —Å–µ—Ä–≤–µ—Ä, API —Ä–æ—É—Ç—ã, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞"
            docker compose build --no-cache api
            echo "‚úÖ API Backend —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
          ENDSSH
      
      - name: üé® –°–±–æ—Ä–∫–∞ UI –õ–µ–Ω–¥–∏–Ω–≥–∞ (ebuster.ru)
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üé® –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É UI –õ–µ–Ω–¥–∏–Ω–≥–∞..."
            echo "üì¶ Dockerfile: Dockerfile.frontend"
            echo "üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, Tailwind CSS, Vite —Å–±–æ—Ä–∫–∞"
            echo "üåê –î–æ–º–µ–Ω—ã: ebuster.ru, www.ebuster.ru"
            docker compose build --no-cache frontend
            echo "‚úÖ UI –õ–µ–Ω–¥–∏–Ω–≥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
          ENDSSH
      
      - name: üë§ –°–±–æ—Ä–∫–∞ UI –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ (lk.ebuster.ru)
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üë§ UI –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º"
            echo "üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: DashboardApp, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã, –±–∏–ª–ª–∏–Ω–≥"
            echo "üåê –î–æ–º–µ–Ω: lk.ebuster.ru"
            echo "‚úÖ UI –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –≥–æ—Ç–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ –æ–±—Ä–∞–∑ frontend)"
          ENDSSH
      
      - name: üõ°Ô∏è  –°–±–æ—Ä–∫–∞ UI –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª–∏ (admin.ebuster.ru)
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üõ°Ô∏è  UI –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª–∏ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º"
            echo "üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: AdminApp, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —Ä–æ–ª—è–º–∏, —Å–∫—Ä–∏–ø—Ç–∞–º–∏"
            echo "üåê –î–æ–º–µ–Ω: admin.ebuster.ru"
            echo "‚úÖ UI –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª–∏ –≥–æ—Ç–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ –æ–±—Ä–∞–∑ frontend)"
          ENDSSH
      
      - name: üì° –°–±–æ—Ä–∫–∞ Autotest Stream Server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üì° –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É Autotest Stream Server..."
            echo "üì¶ Dockerfile: Dockerfile.autotest-stream"
            echo "üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: WebSocket —Å–µ—Ä–≤–µ—Ä, live-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤"
            echo "üåê –ü–æ—Ä—Ç: 3002"
            docker compose build --no-cache autotest-stream
            echo "‚úÖ Autotest Stream Server —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
          ENDSSH
      
      - name: üìä –°–±–æ—Ä–∫–∞ Autotest Dashboard Init
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üìä –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É Autotest Dashboard Init..."
            echo "üì¶ Dockerfile: Dockerfile.autotest"
            echo "üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: Playwright, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞"
            echo "üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –°–æ–∑–¥–∞–Ω–∏–µ placeholder –¥–ª—è autotest.ebuster.ru"
            docker compose build --no-cache autotest-dashboard-init
            echo "‚úÖ Autotest Dashboard Init —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 6: –ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í
      # ============================================
      
      - name: ‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞—é –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã..."
            echo "üìã –ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞:"
            echo "   1. autotest-stream (WebSocket —Å–µ—Ä–≤–µ—Ä)"
            echo "   2. autotest-dashboard-init (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è placeholder)"
            echo "   3. api (Backend API)"
            echo "   4. frontend (Nginx + –≤—Å–µ UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)"
            docker compose up -d
            echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã"
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 7: –û–ñ–ò–î–ê–ù–ò–ï –ó–ê–ü–£–°–ö–ê –°–ï–†–í–ò–°–û–í
      # ============================================
      
      - name: ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "‚è≥ –û–∂–∏–¥–∞—é –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (15 —Å–µ–∫—É–Ω–¥)..."
            sleep 15
            echo "‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 8: –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í
      # ============================================
      
      - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo "üìä –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose ps
            echo ""
            echo "üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" || true
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 9: –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–û–°–¢–ò
      # ============================================
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API Backend (api.ebuster.ru)
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é API Backend..."
            for i in {1..5}; do
              if curl -f -s https://api.ebuster.ru/api/health > /dev/null; then
                echo "‚úÖ API Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
                curl -s https://api.ebuster.ru/api/health | head -5
                exit 0
              fi
              echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/5... –û–∂–∏–¥–∞—é 3 —Å–µ–∫—É–Ω–¥—ã"
              sleep 3
            done
            echo "‚ùå API Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫"
            exit 1
          ENDSSH
      
      - name: üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –õ–µ–Ω–¥–∏–Ω–≥–∞ (ebuster.ru)
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üåê –ü—Ä–æ–≤–µ—Ä—è—é –õ–µ–Ω–¥–∏–Ω–≥..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://ebuster.ru/ || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ –õ–µ–Ω–¥–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $STATUS)"
            else
              echo "‚ö†Ô∏è  –õ–µ–Ω–¥–∏–Ω–≥ –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å: $STATUS"
            fi
          ENDSSH
      
      - name: üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ (lk.ebuster.ru)
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üë§ –ü—Ä–æ–≤–µ—Ä—è—é –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://lk.ebuster.ru/ || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $STATUS)"
            else
              echo "‚ö†Ô∏è  –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å: $STATUS"
            fi
          ENDSSH
      
      - name: üõ°Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª–∏ (admin.ebuster.ru)
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üõ°Ô∏è  –ü—Ä–æ–≤–µ—Ä—è—é –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://admin.ebuster.ru/ || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ (HTTP $STATUS)"
            else
              echo "‚ö†Ô∏è  –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ —Å—Ç–∞—Ç—É—Å: $STATUS"
            fi
          ENDSSH
      
      - name: üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ Autotest Stream Server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            echo "üì° –ü—Ä–æ–≤–µ—Ä—è—é Autotest Stream Server..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3002/status || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Autotest Stream Server —Ä–∞–±–æ—Ç–∞–µ—Ç (HTTP $STATUS)"
            else
              echo "‚ö†Ô∏è  Autotest Stream Server –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å: $STATUS"
            fi
          ENDSSH
      
      # ============================================
      # –≠–¢–ê–ü 10: –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò –û–¢–ß–Å–¢
      # ============================================
      
      - name: üìã –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ –¥–µ–ø–ª–æ–µ
        if: success()
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            set -e
            cd /srv/ebuster
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "üéâ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–Å–ù!"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üìå –†–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –∫–æ–º–º–∏—Ç: $(git rev-parse HEAD)"
            echo "üìù –°–æ–æ–±—â–µ–Ω–∏–µ: $(git log -1 --pretty=format:'%s')"
            echo "üë§ –ê–≤—Ç–æ—Ä: $(git log -1 --pretty=format:'%an')"
            echo "üïê –í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç:"
            echo "   ‚Ä¢ API Backend: https://api.ebuster.ru"
            echo "   ‚Ä¢ –õ–µ–Ω–¥–∏–Ω–≥: https://ebuster.ru"
            echo "   ‚Ä¢ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç: https://lk.ebuster.ru"
            echo "   ‚Ä¢ –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å: https://admin.ebuster.ru"
            echo "   ‚Ä¢ Autotest Dashboard: https://autotest.ebuster.ru"
            echo ""
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
            echo ""
          ENDSSH
      
      - name: ‚ùå –û—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–µ –¥–µ–ø–ª–æ—è
        if: failure()
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH' || true
            set +e
            cd /srv/ebuster
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "‚ùå –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ò–õ–°–Ø –° –û–®–ò–ë–ö–û–ô!"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üìã –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose logs --tail=50 || true
            echo ""
            echo "üíæ –î–ª—è –æ—Ç–∫–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
            ROLLBACK=$(cat /tmp/ebuster_rollback_commit.txt 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω")
            echo "   git reset --hard $ROLLBACK"
            echo "   docker compose up -d"
            echo ""
          ENDSSH
