# Инструкции по применению миграции БД

## Добавление новых полей для пользователей

### Шаг 1: Применить SQL миграцию

Зайдите в Supabase Dashboard → SQL Editor и выполните скрипт из файла:
```
src/lib/add-user-fields.sql
```

Этот скрипт:
1. Добавит новые поля в таблицу `auth_users`:
   - `location` - местоположение пользователя
   - `browser` - браузер пользователя
   - `downloads` - количество загрузок скриптов
   - `scripts` - количество установленных скриптов
   - `last_active` - последняя активность

2. Обновит существующих пользователей:
   - Установит `status = 'active'` если `email_confirmed = true`
   - Установит `status = 'inactive'` если `email_confirmed = false`

3. Создаст триггеры:
   - Автоматическое изменение статуса при подтверждении email
   - Автоматическое обновление `last_active` при входе

### Шаг 2: Проверить изменения

После применения миграции проверьте:
1. Новые пользователи создаются со статусом `inactive`
2. При подтверждении email статус меняется на `active`
3. В админке отображаются все новые поля

### Шаг 3: Настроить отслеживание активности

Новые API endpoints:
- `POST /api/user/activity` - обновление browser, location, last_active
- `POST /api/user/increment-downloads` - увеличение счетчика загрузок

Эти endpoints можно вызывать из фронтенда для отслеживания активности пользователей.

## Что изменилось

### Backend:
- ✅ При регистрации ставится `status = 'inactive'`
- ✅ При подтверждении email статус меняется на `active`
- ✅ Добавлены функции для отслеживания активности
- ✅ Добавлены счетчики загрузок и скриптов

### Frontend (Админка):
- ✅ Отображение местоположения и браузера
- ✅ Отображение количества загрузок и скриптов
- ✅ Отображение последней активности
- ✅ Корректное отображение статуса (Активен/Неактивен/Забанен)
