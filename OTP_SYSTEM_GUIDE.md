# 🔐 Система OTP Аутентификации

## ✅ Что реализовано:

### 1. Backend ✅

#### Генерация OTP кода:
- **Файл:** `src/api/auth.controller.ts`
- Генерируется 6-значный код: `123456`
- Срок действия: **10 минут**
- Сохраняется в поле `confirmation_token`
- Добавлено поле `otp_expiry` для проверки истечения

#### Endpoint проверки OTP:
- **URL:** `POST /api/auth/verify-otp`
- **Параметры:**
  ```json
  {
    "email": "user@example.com",
    "otp": "123456"
  }
  ```
- **Ответ при успехе:**
  ```json
  {
    "success": true,
    "message": "Email подтвержден! Добро пожаловать!",
    "token": "jwt_token_here",
    "user": {
      "id": "user_id",
      "email": "user@example.com",
      "full_name": "Имя Пользователя",
      "role": "user",
      "status": "active"
    }
  }
  ```

#### Email с OTP кодом:
- **Файл:** `src/services/email.service.ts`
- Метод: `sendOtpEmail(email, otpCode, userName)`
- Красивый HTML шаблон с:
  - Градиентной рамкой вокруг кода
  - Крупным шрифтом (48px)
  - Таймером (10 минут)
  - Предупреждением о безопасности
  - Брендированным дизайном

---

### 2. Frontend ✅

#### Страница ввода OTP:
- **Файл:** `src/pages/VerifyOtp.tsx`
- **URL:** `/verify-otp?email=user@example.com`
- **Компоненты:**
  - `InputOTP` - 6 полей для ввода кода
  - Автоматическая отправка при вводе 6 цифр
  - Кнопка "Отправить повторно" с cooldown 60 секунд
  - Индикатор загрузки
  - Информационные блоки

#### Автоматический вход:
- После успешной проверки OTP:
  1. Сохраняется JWT токен
  2. Сохраняются данные пользователя
  3. Обновляется контекст авторизации
  4. Автоматическое перенаправление в `/dashboard`

#### Интеграция с регистрацией:
- **Файл:** `src/contexts/CustomAuthContext.tsx`
- После успешной регистрации:
  1. Показывается уведомление
  2. Через 1.5 секунды перенаправление на `/verify-otp?email=...`

---

## 🎨 UI/UX Особенности:

### Страница ввода OTP:

```
┌─────────────────────────────────────┐
│         📧 Подтверждение Email      │
│                                     │
│  Мы отправили 6-значный код на     │
│  user@example.com                  │
│                                     │
│  ┌───┬───┬───┐ • ┌───┬───┬───┐    │
│  │ 1 │ 2 │ 3 │   │ 4 │ 5 │ 6 │    │
│  └───┴───┴───┘   └───┴───┴───┘    │
│                                     │
│  ✓ Код действителен 10 минут      │
│  ⚠️ Не получили код?               │
│                                     │
│  [Отправить код повторно]          │
│  [Вернуться к регистрации]         │
└─────────────────────────────────────┘
```

### Email шаблон:

```
╔═══════════════════════════════════╗
║         EBUSTER                   ║
║   Расширение нового поколения     ║
╠═══════════════════════════════════╣
║                                   ║
║  Добро пожаловать, Имя!          ║
║                                   ║
║  Ваш код подтверждения:          ║
║                                   ║
║  ╔═══════════════════╗            ║
║  ║                   ║            ║
║  ║     1 2 3 4 5 6   ║            ║
║  ║                   ║            ║
║  ╚═══════════════════╝            ║
║                                   ║
║  ⏱ Код действителен 10 минут     ║
║  ⚠️ Никому не сообщайте код       ║
║                                   ║
╚═══════════════════════════════════╝
```

---

## 🔄 Процесс регистрации:

### Старый процесс (со ссылкой):
```
1. Регистрация → 
2. Email со ссылкой → 
3. Клик по ссылке → 
4. Подтверждение → 
5. Логин → 
6. Вход в систему
```

### Новый процесс (с OTP):
```
1. Регистрация → 
2. Email с OTP кодом → 
3. Ввод кода (6 цифр) → 
4. Автоматический вход в систему ✨
```

**Преимущества:**
- ✅ Меньше шагов (4 вместо 6)
- ✅ Не нужно логиниться
- ✅ Быстрее и удобнее
- ✅ Современный UX
- ✅ Мобильно-дружественный

---

## 📊 База данных:

### Новые поля в таблице `auth_users`:

```sql
ALTER TABLE auth_users 
ADD COLUMN otp_expiry TIMESTAMPTZ;

-- confirmation_token теперь хранит OTP код (6 цифр)
-- otp_expiry хранит время истечения кода
```

---

## 🧪 Тестирование:

### 1. Регистрация нового пользователя:

```bash
# Откройте http://localhost:5173
# Нажмите "Регистрация"
# Заполните форму
# Нажмите "Зарегистрироваться"
```

**Ожидаемый результат:**
- ✅ Уведомление: "Код подтверждения отправлен"
- ✅ Перенаправление на `/verify-otp?email=...`
- ✅ Email с 6-значным кодом

### 2. Проверка email:

Откройте полученное письмо:
```
Тема: Код подтверждения - EBUSTER

Ваш код: 123456

⏱ Код действителен 10 минут
```

### 3. Ввод OTP кода:

На странице `/verify-otp`:
- Введите 6 цифр из email
- Код проверяется автоматически
- При успехе: автоматический вход

**Ожидаемый результат:**
- ✅ Уведомление: "Email подтвержден! Добро пожаловать!"
- ✅ Перенаправление в `/dashboard`
- ✅ Пользователь авторизован

### 4. Проверка истечения кода:

Подождите 10 минут и попробуйте ввести код:
```json
{
  "success": false,
  "error": "OTP код истек. Пожалуйста, зарегистрируйтесь заново."
}
```

---

## 🔐 Безопасность:

### Защита от брутфорса:
- ⏱ Код действителен только 10 минут
- 🔢 6-значный код (1 миллион комбинаций)
- 🚫 После истечения нужна новая регистрация

### Рекомендации для production:
1. **Rate limiting:** Ограничить количество попыток ввода OTP
2. **IP tracking:** Отслеживать подозрительную активность
3. **Captcha:** Добавить при повторной отправке кода
4. **Логирование:** Записывать все попытки проверки OTP

---

## 📝 API Документация:

### POST /api/auth/register

**Request:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "fullName": "Иван Иванов"
}
```

**Response:**
```json
{
  "success": true,
  "emailSent": true,
  "message": "Пользователь создан. Письмо отправлено.",
  "userId": "user_id_here"
}
```

**Email содержит:**
- 6-значный OTP код
- Срок действия: 10 минут

---

### POST /api/auth/verify-otp

**Request:**
```json
{
  "email": "user@example.com",
  "otp": "123456"
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Email подтвержден! Добро пожаловать!",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "full_name": "Иван Иванов",
    "role": "user",
    "status": "active"
  }
}
```

**Response (Error - Неверный код):**
```json
{
  "success": false,
  "error": "Неверный OTP код или email"
}
```

**Response (Error - Истек):**
```json
{
  "success": false,
  "error": "OTP код истек. Пожалуйста, зарегистрируйтесь заново."
}
```

---

## 🚀 Деплой:

### 1. Обновите базу данных:

```sql
-- Добавьте поле otp_expiry
ALTER TABLE auth_users 
ADD COLUMN IF NOT EXISTS otp_expiry TIMESTAMPTZ;
```

### 2. Перезапустите backend:

```bash
npm run dev
```

### 3. Проверьте frontend:

```bash
# Убедитесь что роут /verify-otp работает
# Проверьте что компонент InputOTP существует
```

---

## ✅ Чеклист готовности:

- [x] Backend генерирует 6-значный OTP
- [x] OTP сохраняется в БД с временем истечения
- [x] Endpoint `/api/auth/verify-otp` работает
- [x] Email с OTP отправляется
- [x] Страница `/verify-otp` создана
- [x] Компонент InputOTP интегрирован
- [x] Автоматический вход после проверки OTP
- [x] Перенаправление после регистрации
- [x] Обработка ошибок
- [x] Cooldown для повторной отправки

---

## 🎉 Готово!

Система OTP полностью интегрирована и готова к использованию!

**Пользователи теперь могут:**
1. Зарегистрироваться
2. Получить OTP код на email
3. Ввести код (6 цифр)
4. Автоматически войти в систему

**Без необходимости:**
- ❌ Кликать по ссылкам
- ❌ Вводить логин/пароль повторно
- ❌ Ждать долгих редиректов

**Современно, быстро, удобно!** ✨
