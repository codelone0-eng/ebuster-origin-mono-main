FROM mcr.microsoft.com/playwright:v1.56.1-jammy

WORKDIR /app

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ package files (ÐºÑÑˆÐ¸Ñ€ÑƒÐµÑ‚ÑÑ ÐµÑÐ»Ð¸ Ð½Ðµ Ð¼ÐµÐ½ÑÑŽÑ‚ÑÑ)
COPY package*.json ./

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (npm ci Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ npm install)
RUN npm ci && npm cache clean --force

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ð¸ÐºÐ¸ Ñ‚ÐµÑÑ‚Ð¾Ð² Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹
COPY tests ./tests
COPY tsconfig*.json ./
COPY run-tests-and-deploy.sh ./
COPY .env.autotest* ./

# Ð”ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼
RUN chmod +x run-tests-and-deploy.sh

# Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð²
RUN mkdir -p tests/public/autotest tests/reports tests/storage

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
ENV NODE_ENV=production
ENV CI=true

# Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ init-ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ð°
RUN echo '#!/bin/sh\n\
if [ ! -f /app/tests/public/autotest/index.html ]; then\n\
  echo "ðŸ“ Generating initial dashboard placeholder..."\n\
  npm run test:dashboard:live || echo "âš ï¸  Failed to generate placeholder"\n\
fi\n\
exec "$@"' > /app/init.sh && chmod +x /app/init.sh

ENTRYPOINT ["/app/init.sh"]
CMD ["npm", "run", "test:all"]
