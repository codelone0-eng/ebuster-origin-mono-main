#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð°Ð²Ñ‚Ð¾Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð· Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ GitHub Actions

set -e

echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð´Ð»Ñ EBUSTER"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
if [ ! -d "/srv/ebuster" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ /srv/ebuster Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
    echo "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð¿ÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÑƒ ÑÐµÑ€Ð²ÐµÑ€Ð°."
    exit 1
fi

echo "1ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ SSH-ÐºÐ»ÑŽÑ‡Ð° Ð´Ð»Ñ GitHub Actions..."
SSH_KEY_PATH="$HOME/.ssh/github_actions_key"

if [ -f "$SSH_KEY_PATH" ]; then
    echo "âš ï¸  SSH-ÐºÐ»ÑŽÑ‡ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚: $SSH_KEY_PATH"
    read -p "ÐŸÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÐºÐ»ÑŽÑ‡."
    else
        rm -f "$SSH_KEY_PATH" "$SSH_KEY_PATH.pub"
        ssh-keygen -t ed25519 -C "github-actions@ebuster.ru" -f "$SSH_KEY_PATH" -N ""
        echo "âœ… ÐÐ¾Ð²Ñ‹Ð¹ SSH-ÐºÐ»ÑŽÑ‡ ÑÐ¾Ð·Ð´Ð°Ð½"
    fi
else
    ssh-keygen -t ed25519 -C "github-actions@ebuster.ru" -f "$SSH_KEY_PATH" -N ""
    echo "âœ… SSH-ÐºÐ»ÑŽÑ‡ ÑÐ¾Ð·Ð´Ð°Ð½"
fi

echo ""
echo "2ï¸âƒ£ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð° Ð² authorized_keys..."
if grep -q "$(cat $SSH_KEY_PATH.pub)" "$HOME/.ssh/authorized_keys" 2>/dev/null; then
    echo "âœ… ÐšÐ»ÑŽÑ‡ ÑƒÐ¶Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² authorized_keys"
else
    cat "$SSH_KEY_PATH.pub" >> "$HOME/.ssh/authorized_keys"
    chmod 600 "$HOME/.ssh/authorized_keys"
    echo "âœ… ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½"
fi

echo ""
echo "3ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
chmod 700 "$HOME/.ssh"
chmod 600 "$SSH_KEY_PATH"
chmod 644 "$SSH_KEY_PATH.pub"
echo "âœ… ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"

echo ""
echo "4ï¸âƒ£ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ GitHub Secrets..."
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“‹ Ð¡ÐšÐžÐŸÐ˜Ð Ð£Ð™Ð¢Ð• Ð¡Ð›Ð•Ð”Ð£Ð®Ð©Ð£Ð® Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð® Ð’ GITHUB SECRETS:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ IP ÑÐµÑ€Ð²ÐµÑ€Ð°
SERVER_IP=$(curl -s ifconfig.me || hostname -I | awk '{print $1}')
SERVER_USER=$(whoami)

echo "ðŸ”‘ Ð¡ÐµÐºÑ€ÐµÑ‚: SSH_PRIVATE_KEY"
echo "   Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ (ÑÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²ÐµÑÑŒ Ð±Ð»Ð¾Ðº Ð½Ð¸Ð¶Ðµ, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ BEGIN/END):"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
cat "$SSH_KEY_PATH"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸŒ Ð¡ÐµÐºÑ€ÐµÑ‚: SERVER_IP"
echo "   Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: $SERVER_IP"
echo ""
echo "ðŸ‘¤ Ð¡ÐµÐºÑ€ÐµÑ‚: SERVER_USER"
echo "   Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: $SERVER_USER"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "5ï¸âƒ£ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸ÑŽ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² Ð² GitHub:"
echo ""
echo "   1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ: https://github.com/codelone0-eng/ebuster-origin-mono-main/settings/secrets/actions"
echo "   2. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'New repository secret'"
echo "   3. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ñ‚Ñ€Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ð° Ñ Ð¸Ð¼ÐµÐ½Ð°Ð¼Ð¸ Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð²Ñ‹ÑˆÐµ"
echo ""

echo "6ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´ÐµÐ¿Ð»Ð¾Ñ..."
if [ -f "/srv/ebuster/deploy.sh" ]; then
    chmod +x /srv/ebuster/deploy.sh
    echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ deploy.sh Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ"
else
    echo "âš ï¸  Ð¤Ð°Ð¹Ð» deploy.sh Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² /srv/ebuster/"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ“ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo ""
echo "   1. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð² GitHub (Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð²Ñ‹ÑˆÐµ)"
echo "   2. Ð¡Ð´ÐµÐ»Ð°Ð¹Ñ‚Ðµ git push Ð² Ð²ÐµÑ‚ÐºÑƒ main"
echo "   3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¹: https://github.com/codelone0-eng/ebuster-origin-mono-main/actions"
echo ""
echo "ðŸš€ ÐŸÐ¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ push Ð² main Ð±ÑƒÐ´ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ÑŒÑÑ!"
echo ""

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð² Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð°
INFO_FILE="/srv/ebuster/github-secrets.txt"
cat > "$INFO_FILE" << EOF
GitHub Secrets Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð´ÐµÐ¿Ð»Ð¾Ñ EBUSTER
Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾: $(date)

SSH_PRIVATE_KEY:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
$(cat "$SSH_KEY_PATH")
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

SERVER_IP: $SERVER_IP

SERVER_USER: $SERVER_USER

GitHub URL: https://github.com/codelone0-eng/ebuster-origin-mono-main/settings/secrets/actions
EOF

chmod 600 "$INFO_FILE"
echo "ðŸ’¾ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð²: $INFO_FILE"
echo "   (Ð´Ð»Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°: cat $INFO_FILE)"
echo ""
