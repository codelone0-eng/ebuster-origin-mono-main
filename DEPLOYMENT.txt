═══════════════════════════════════════════════════════════════════════════════
  EBUSTER - ИНСТРУКЦИЯ ПО ДЕПЛОЮ НА UBUNTU 20.04 ЧЕРЕЗ DOCKER
═══════════════════════════════════════════════════════════════════════════════

📋 АРХИТЕКТУРА
──────────────────────────────────────────────────────────────────────────────
  ebuster.ru          → Лендинг (Nginx + React SPA)
  lk.ebuster.ru       → Личный кабинет (Nginx + React SPA)
  admin.ebuster.ru    → Админка (Nginx + React SPA)
  api.ebuster.ru      → API Backend (Node.js + Express)
  cdn.ebuster.ru      → Supabase Storage (настраивается в Supabase)

  Все сервисы работают в Docker контейнерах:
  - ebuster-api       → API сервер (порт 3001)
  - ebuster-frontend  → Nginx с SPA (порт 80/443)

═══════════════════════════════════════════════════════════════════════════════
  1. ПОДГОТОВКА СЕРВЕРА UBUNTU 20.04
═══════════════════════════════════════════════════════════════════════════════

# Обновление системы
sudo apt update && sudo apt upgrade -y

# Установка Docker
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
sudo apt update
sudo apt install -y docker-ce

# Установка Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Добавление пользователя в группу docker
sudo usermod -aG docker $USER
newgrp docker

# Установка Git
sudo apt install -y git

# Настройка Firewall
sudo ufw allow OpenSSH
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

═══════════════════════════════════════════════════════════════════════════════
  2. КЛОНИРОВАНИЕ И НАСТРОЙКА ПРОЕКТА
═══════════════════════════════════════════════════════════════════════════════

# Создание директории для проекта
sudo mkdir -p /srv/ebuster
sudo chown $USER:$USER /srv/ebuster

# Клонирование репозитория
cd /srv/ebuster
git clone <ваш-репозиторий> .

# Копирование production .env
cp .env.production .env

# Редактирование .env (если нужно)
nano .env

# Создание директории для SSL сертификатов
mkdir -p ssl

═══════════════════════════════════════════════════════════════════════════════
  3. DNS НАСТРОЙКА
═══════════════════════════════════════════════════════════════════════════════

Добавьте A-записи в вашем DNS провайдере:

  ebuster.ru          → IP_ВАШЕГО_СЕРВЕРА
  www.ebuster.ru      → IP_ВАШЕГО_СЕРВЕРА
  api.ebuster.ru      → IP_ВАШЕГО_СЕРВЕРА
  lk.ebuster.ru       → IP_ВАШЕГО_СЕРВЕРА
  admin.ebuster.ru    → IP_ВАШЕГО_СЕРВЕРА

Для CDN (Supabase Storage):
  cdn.ebuster.ru      → CNAME на ваш Supabase проект
                        (настраивается в Supabase Dashboard)

Подождите распространения DNS (5-30 минут).

═══════════════════════════════════════════════════════════════════════════════
  4. СБОРКА И ЗАПУСК DOCKER КОНТЕЙНЕРОВ
═══════════════════════════════════════════════════════════════════════════════

# Сборка образов
cd /srv/ebuster
docker-compose build

# Запуск контейнеров
docker-compose up -d

# Проверка статуса
docker-compose ps

# Просмотр логов
docker-compose logs -f

# Проверка здоровья API
curl http://localhost:3001/api/health

═══════════════════════════════════════════════════════════════════════════════
  5. НАСТРОЙКА SSL СЕРТИФИКАТОВ (Let's Encrypt)
═══════════════════════════════════════════════════════════════════════════════

# Остановка контейнеров на время получения сертификатов
docker-compose down

# Установка Certbot
sudo snap install core; sudo snap refresh core
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot

# Получение сертификатов
sudo certbot certonly --standalone -d ebuster.ru -d www.ebuster.ru -d api.ebuster.ru -d lk.ebuster.ru -d admin.ebuster.ru

# Копирование сертификатов в проект
sudo cp /etc/letsencrypt/live/ebuster.ru/fullchain.pem /srv/ebuster/ssl/
sudo cp /etc/letsencrypt/live/ebuster.ru/privkey.pem /srv/ebuster/ssl/
sudo chown $USER:$USER /srv/ebuster/ssl/*

# Обновление nginx.conf для HTTPS
# (добавить server блоки на порт 443 с ssl_certificate)

# Перезапуск контейнеров
docker-compose up -d

# Настройка автообновления сертификатов
sudo certbot renew --dry-run

═══════════════════════════════════════════════════════════════════════════════
  6. НАСТРОЙКА SUPABASE CDN
═══════════════════════════════════════════════════════════════════════════════

1. Зайдите в Supabase Dashboard → Storage
2. Создайте bucket с именем "cdn" (если не создан)
3. Настройте bucket как Public
4. Добавьте RLS политику для публичного чтения:

   CREATE POLICY "Public read access"
   ON storage.objects FOR SELECT
   USING (bucket_id = 'cdn');

5. В настройках проекта → Custom Domains
   Добавьте cdn.ebuster.ru и следуйте инструкциям Supabase

═══════════════════════════════════════════════════════════════════════════════
  7. УПРАВЛЕНИЕ КОНТЕЙНЕРАМИ
═══════════════════════════════════════════════════════════════════════════════

# Остановка всех контейнеров
docker-compose down

# Запуск контейнеров
docker-compose up -d

# Перезапуск конкретного сервиса
docker-compose restart api
docker-compose restart frontend

# Просмотр логов
docker-compose logs -f api
docker-compose logs -f frontend

# Обновление после изменений в коде
git pull
docker-compose build
docker-compose up -d

# Очистка неиспользуемых образов
docker system prune -a

═══════════════════════════════════════════════════════════════════════════════
  8. МОНИТОРИНГ И ПРОВЕРКА
═══════════════════════════════════════════════════════════════════════════════

# Проверка API
curl https://api.ebuster.ru/api/health

# Проверка фронтендов
curl -I https://ebuster.ru
curl -I https://lk.ebuster.ru
curl -I https://admin.ebuster.ru

# Проверка логов Nginx
docker exec ebuster-frontend tail -f /var/log/nginx/access.log
docker exec ebuster-frontend tail -f /var/log/nginx/error.log

# Проверка использования ресурсов
docker stats

═══════════════════════════════════════════════════════════════════════════════
  9. АВТОЗАПУСК ПРИ ПЕРЕЗАГРУЗКЕ СЕРВЕРА
═══════════════════════════════════════════════════════════════════════════════

Docker Compose автоматически настроен с restart: unless-stopped
Контейнеры будут автоматически запускаться при перезагрузке сервера.

Для проверки:
sudo reboot
# После перезагрузки
docker-compose ps

═══════════════════════════════════════════════════════════════════════════════
  10. БЕЗОПАСНОСТЬ И BEST PRACTICES
═══════════════════════════════════════════════════════════════════════════════

✓ Все секреты в .env файле (не коммитить в Git)
✓ HTTPS для всех доменов
✓ CORS настроен только для нужных доменов
✓ Cookies с флагами Secure, SameSite=None, Domain=.ebuster.ru
✓ RLS политики в Supabase для изоляции данных
✓ Регулярные обновления системы и Docker образов
✓ Мониторинг логов и метрик
✓ Backup базы данных Supabase

═══════════════════════════════════════════════════════════════════════════════
  11. TROUBLESHOOTING
═══════════════════════════════════════════════════════════════════════════════

Проблема: Контейнеры не запускаются
Решение: docker-compose logs -f
         Проверить .env файл
         Проверить доступность портов: sudo netstat -tulpn | grep :80

Проблема: CORS ошибки
Решение: Проверить настройки в server.ts и nginx.conf
         Убедиться что домены правильно указаны

Проблема: SSL сертификаты не работают
Решение: Проверить что DNS записи настроены
         Проверить что сертификаты скопированы в /srv/ebuster/ssl/
         Проверить nginx конфигурацию

Проблема: API не доступен
Решение: docker-compose logs api
         Проверить что .env файл содержит все нужные переменные
         Проверить подключение к Supabase

═══════════════════════════════════════════════════════════════════════════════
  ГОТОВО! 🚀
═══════════════════════════════════════════════════════════════════════════════

Ваше приложение EBUSTER развернуто и готово к использованию!

Основные URL:
  https://ebuster.ru          - Лендинг
  https://lk.ebuster.ru       - Личный кабинет
  https://admin.ebuster.ru    - Админка
  https://api.ebuster.ru      - API
  https://cdn.ebuster.ru      - CDN (Supabase Storage)
