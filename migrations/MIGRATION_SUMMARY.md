# üéØ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î - –ò—Ç–æ–≥–æ–≤–∞—è –°–≤–æ–¥–∫–∞

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω–∞ —á–∏—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ë–î
**–§–∞–π–ª:** `CLEAN_DB_SETUP.sql`

–°–æ–∑–¥–∞—ë—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å –Ω—É–ª—è:
- ‚úÖ `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–≤–º–µ—Å—Ç–æ `auth_users`)
- ‚úÖ `scripts` - —Å–∫—Ä–∏–ø—Ç—ã
- ‚úÖ `script_versions` - –≤–µ—Ä—Å–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
- ‚úÖ `tickets` - —Ç–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- ‚úÖ `ticket_messages` - —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤
- ‚úÖ `api_keys` - API –∫–ª—é—á–∏
- ‚úÖ `subscriptions` - –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ `login_history` - –∏—Å—Ç–æ—Ä–∏—è –≤—Ö–æ–¥–æ–≤
- ‚úÖ `user_bans` - –±–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 2. –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏
**–§–∞–π–ª:** `SETUP_RLS_POLICIES.sql`

–í–∫–ª—é—á—ë–Ω Row Level Security –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞.

### 3. –û–±–Ω–æ–≤–ª—ë–Ω –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ó–∞–º–µ–Ω–µ–Ω–æ `auth_users` ‚Üí `users` –≤ —Ñ–∞–π–ª–∞—Ö:
- ‚úÖ `src/api/cron-jobs.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `user_bans`
- ‚úÖ `src/api/tickets-new.controller.ts`
- ‚úÖ `src/api/subscriptions.controller.ts`
- ‚úÖ `src/api/roles.controller.ts`
- ‚úÖ `src/lib/supabase-api.ts`
- ‚úÖ `src/api/referral.controller.ts`

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

### –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ –ë–î
```sql
-- –£–¥–∞–ª–∏ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ Supabase Dashboard
-- –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏:
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO public;
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
```sql
-- –ó–∞–ø—É—Å—Ç–∏ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
\i CLEAN_DB_SETUP.sql
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ RLS
```sql
-- –ó–∞–ø—É—Å—Ç–∏ —Ñ–∞–π–ª —Å –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏
\i SETUP_RLS_POLICIES.sql
```

### –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose restart
```

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ

### –¢–∞–±–ª–∏—Ü–∞ `users` (–±—ã–ª–æ `auth_users`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `token_version` (BIGINT) –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤—Å—Ç—Ä–æ–µ–Ω–∞
- ‚úÖ 2FA –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- ‚úÖ –¢–æ–∫–µ–Ω—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è/–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

### –¢–∞–±–ª–∏—Ü–∞ `user_bans`
- ‚úÖ –ü–æ–ª—è: `id`, `user_id`, `reason`, `banned_by`, `is_active`, `banned_at`, `expires_at`, `unbanned_at`
- ‚úÖ –£–±—Ä–∞–Ω—ã: `ban_id`, `ban_type`, `unban_date`

### –¢–∞–±–ª–∏—Ü–∞ `scripts`
- ‚úÖ –ü–æ–ª–µ `name` (–±—ã–ª–æ `title` –≤ —Å—Ç–∞—Ä–æ–π –ë–î)
- ‚úÖ –ü–æ–ª–µ `downloads` (–±—ã–ª–æ `downloads_count`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã: `views`, `is_public`, `icon_url`

### –¢–∞–±–ª–∏—Ü–∞ `tickets`
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è `ticket_number` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –•—Ä–∞–Ω–∏—Ç—Å—è `user_email` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### TypeScript lint –æ—à–∏–±–∫–∏
–û—à–∏–±–∫–∏ —Ç–∏–ø–æ–≤ –≤ `supabase-api.ts` - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Å–≤—è–∑–∞–Ω–æ —Å —Ç–∏–ø–∞–º–∏ Supabase. –ù—É–∂–Ω–æ –±—É–¥–µ—Ç —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã:

```bash
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > src/lib/database.types.ts
```

### –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `node-cron` —Ç–∏–ø—ã
–£—Å—Ç–∞–Ω–æ–≤–∏:
```bash
npm install --save-dev @types/node-cron
```

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:
- ‚úÖ –ß–∏—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω –ø–æ–¥ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã** - —ç—Ç–æ —á–∏—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
2. **–°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–µ–Ω—ã** - —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ, —Ä–æ–ª–∏ –∏ —Ç.–¥.
3. **–£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** - —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

1. –°–¥–µ–ª–∞–π –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
2. –ò—Å–ø–æ–ª—å–∑—É–π Supabase Dashboard ‚Üí Database ‚Üí Backups
3. –ò–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏ –∏–∑ SQL –¥–∞–º–ø–∞
