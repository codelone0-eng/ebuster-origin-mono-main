#!/bin/bash

echo "üöÄ –î–µ–ø–ª–æ–π —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º node-cron..."

cd /srv/ebuster

# –°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "üîÑ –°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
git reset --hard HEAD
git clean -fd

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å GitHub..."
git pull origin main

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose down
docker-compose build --no-cache

# –ó–∞–ø—É—Å–∫
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose up -d

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ API..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
curl -s https://api.ebuster.ru/api/health || echo "API –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤"

echo ""
echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üìù –õ–æ–≥–∏ API: docker-compose logs -f api"
