# üö® –°–†–û–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - Subscriptions

## –ü—Ä–æ–±–ª–µ–º–∞:
```
Error: Could not find the 'amount' column of 'subscriptions' in the schema cache
```

API –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—è `amount`, `plan`, `features` –≤ —Ç–∞–±–ª–∏—Ü–µ `subscriptions`, –Ω–æ –∏—Ö —Ç–∞–º –Ω–µ—Ç!

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï:

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ:** `migrations/QUICK_CHECK.sql`

–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç:
- –ö–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- –ö–∞–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å –≤ `subscriptions`
- –ï—Å—Ç—å –ª–∏ `amount` (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å NO ‚ùå)
- –î–∞–Ω–Ω—ã–µ –∏–∑ `roles` –∏ `auth_users`

**–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!**

---

### –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã subscriptions

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ:** `migrations/FIX_SUBSCRIPTIONS_TABLE.sql`

–≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç:
- ‚úÖ `amount` - —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (DECIMAL)
- ‚úÖ `plan` - –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ (VARCHAR)
- ‚úÖ `features` - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (JSONB)

–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç –∏—Ö –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Ä–æ–ª–∏.

---

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ API

```bash
docker compose restart api
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ subscriptions –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```sql
subscriptions:
  - id (UUID)
  - user_id (UUID) ‚Üí auth_users.id
  - role_id (UUID) ‚Üí roles.id
  - status (VARCHAR)
  - start_date (TIMESTAMP)
  - end_date (TIMESTAMP)
  - payment_method (VARCHAR)
  - transaction_id (VARCHAR)
  - auto_renew (BOOLEAN)
  - amount (DECIMAL) ‚Üê –ù–û–í–û–ï!
  - plan (VARCHAR) ‚Üê –ù–û–í–û–ï!
  - features (JSONB) ‚Üê –ù–û–í–û–ï!
  - created_at (TIMESTAMP)
  - updated_at (TIMESTAMP)
```

---

## üîç –ó–∞—á–µ–º —ç—Ç–∏ –ø–æ–ª—è:

### `amount`
–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤ —Ä—É–±–ª—è—Ö. –ë–µ—Ä–µ—Ç—Å—è –∏–∑ `roles.price_monthly` –∏–ª–∏ `roles.price_yearly`.

**–ü—Ä–∏–º–µ—Ä:**
- Pro –º–µ—Å—è—Ü: `999`
- Pro –≥–æ–¥: `9990`
- Premium –º–µ—Å—è—Ü: `2999`

### `plan`
–î—É–±–ª–∏–∫–∞—Ç `roles.name` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º API.

**–ü—Ä–∏–º–µ—Ä:**
- `free`
- `pro`
- `premium`

### `features`
–î—É–±–ª–∏–∫–∞—Ç `roles.features` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "scripts": {"can_create": true, "can_publish": true},
  "api": {"enabled": true}
}
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ:

–≠—Ç–∏ –ø–æ–ª—è **–¥—É–±–ª–∏—Ä—É—é—Ç** –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `roles`, –Ω–æ –Ω—É–∂–Ω—ã –¥–ª—è:
1. –û–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º API
2. –ò—Å—Ç–æ—Ä–∏–∏ - –µ—Å–ª–∏ —Ä–æ–ª—å –∏–∑–º–µ–Ω–∏—Ç—Å—è, –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Å—Ç–∞—Ä—ã–µ —É—Å–ª–æ–≤–∏—è
3. –ë—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ JOIN

---

## üéØ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. ‚úÖ API `/api/admin/subscriptions` –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç
3. ‚úÖ –ê–¥–º–∏–Ω–∫–∞ –ø–æ–∫–∞–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏
4. ‚úÖ –û—à–∏–±–∫–∞ 500 –∏—Å—á–µ–∑–Ω–µ—Ç

---

## üìù –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ):

–ú–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å `amount`, `plan`, `features` –∏–∑ –∫–æ–¥–∞ API –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `role_id`.

–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ:
1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `src/api/subscriptions.controller.ts`
2. –£–±—Ä–∞—Ç—å –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è `amount`, `plan`, `features`
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JOIN —Å `roles` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö

–ù–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ –∏ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ.

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ FIX_SUBSCRIPTIONS_TABLE.sql** - —ç—Ç–æ —Å–∞–º–æ–µ –±—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ!

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—Å–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É.
